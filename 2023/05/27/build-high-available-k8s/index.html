<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>搭建高可用k8s集群 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="一,机器规划   角色 ip 组件    k8s-master 192.168.254.3 kube-apiserver，kube-controller-manager，kube-scheduler，etcd   k8s-node1 192.168.254.4 kubelet，kube-proxy，docker  etcd   k8s-node2 192.168.254.5 kubelet，kub">
<meta property="og:type" content="article">
<meta property="og:title" content="搭建高可用k8s集群">
<meta property="og:url" content="http://example.com/2023/05/27/build-high-available-k8s/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="一,机器规划   角色 ip 组件    k8s-master 192.168.254.3 kube-apiserver，kube-controller-manager，kube-scheduler，etcd   k8s-node1 192.168.254.4 kubelet，kube-proxy，docker  etcd   k8s-node2 192.168.254.5 kubelet，kub">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-05-27T14:41:17.000Z">
<meta property="article:modified_time" content="2024-04-03T03:30:41.833Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-build-high-available-k8s" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/05/27/build-high-available-k8s/" class="article-date">
  <time class="dt-published" datetime="2023-05-27T14:41:17.000Z" itemprop="datePublished">2023-05-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/articture/">articture</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      搭建高可用k8s集群
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="一-机器规划"><a href="#一-机器规划" class="headerlink" title="一,机器规划"></a>一,机器规划</h3><table>
<thead>
<tr>
<th>角色</th>
<th>ip</th>
<th>组件</th>
</tr>
</thead>
<tbody><tr>
<td>k8s-master</td>
<td>192.168.254.3</td>
<td>kube-apiserver，kube-controller-manager，kube-scheduler，etcd</td>
</tr>
<tr>
<td>k8s-node1</td>
<td>192.168.254.4</td>
<td>kubelet，kube-proxy，docker  etcd</td>
</tr>
<tr>
<td>k8s-node2</td>
<td>192.168.254.5</td>
<td>kubelet，kube-proxy，docker，etcd</td>
</tr>
</tbody></table>
<h3 id="二-操作系统初始化"><a href="#二-操作系统初始化" class="headerlink" title="二,操作系统初始化"></a>二,操作系统初始化</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">关闭 防火墙</span></span><br><span class="line">systemctl stop firewalld &amp;&amp; systemctl disable firewalld</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">关闭 swap</span></span><br><span class="line">sed -i &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭  SELINUX</span></span><br><span class="line">sed -i &quot;s/^SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/sysconfig/selinux</span><br><span class="line">sed -i &quot;s/^SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/selinux/config</span><br><span class="line">sed -i &quot;s/^SELINUX=permissive/SELINUX=disabled/g&quot; /etc/sysconfig/selinux</span><br><span class="line">sed -i &quot;s/^SELINUX=permissive/SELINUX=disabled/g&quot; /etc/selinux/config</span><br><span class="line"></span><br><span class="line">timedatectl set-timezone Asia/Shanghai &amp;&amp; timedatectl set-local-rtc 0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">时间同步</span></span><br><span class="line">yum install ntpdate -y &amp;&amp; ntpdate time.windows.com</span><br><span class="line"></span><br><span class="line">echo &quot;* soft nofile 65536&quot; &gt;&gt; /etc/security/limits.conf</span><br><span class="line">echo &quot;* hard nofile 65536&quot; &gt;&gt; /etc/security/limits.conf</span><br><span class="line">echo &quot;* soft nproc 65536&quot; &gt;&gt; /etc/security/limits.conf</span><br><span class="line">echo &quot;* hard nproc 65536&quot; &gt;&gt; /etc/security/limits.conf</span><br><span class="line">echo &quot;* soft memlock unlimited&quot; &gt;&gt; /etc/security/limits.conf</span><br><span class="line">echo &quot;* hard memlock unlimited&quot; &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置 ipvs</span></span><br><span class="line">modprobe -- ip_vs &amp;&amp; modprobe -- ip_vs_rr &amp;&amp; modprobe -- ip_vs_wrr &amp;&amp; modprobe -- ip_vs_sh &amp;&amp; modprobe -- nf_conntrack_ipv4</span><br><span class="line">yum install -y ipvsadm</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>hostnamectl set-hostname  192.168.254.3</p>
<p>hostnamectl set-hostname  192.168.254.4</p>
<p>hostnamectl set-hostname  192.168.254.5</p>
<h2 id="二，生成https证书"><a href="#二，生成https证书" class="headerlink" title="二，生成https证书"></a>二，生成https证书</h2><p>cfssl是一个开源的证书管理工具，使用json文件生成证书，相比openssl更方便使用。</p>
<p>找任意一台服务器操作，这里用Master节点。</p>
<p>cp cfssl_linux-amd64 &#x2F;usr&#x2F;local&#x2F;bin&#x2F;cfssl &amp;&amp; cp cfssljson_linux-amd64 &#x2F;usr&#x2F;local&#x2F;bin&#x2F;cfssljson &amp;&amp; cp cfssl-certinfo_linux-amd64 &#x2F;usr&#x2F;bin&#x2F;cfssl-certinfo</p>
<p>如下是生成的详细过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"> cat &gt; ca-config.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">         &quot;expiry&quot;: &quot;87600h&quot;,</span><br><span class="line">         &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; ca-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">              &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; server-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">      &quot;127.0.0.1&quot;,</span><br><span class="line">      &quot;192.168.254.3&quot;,</span><br><span class="line">      &quot;192.168.254.4&quot;,</span><br><span class="line">      &quot;192.168.254.5&quot;,</span><br><span class="line">      &quot;10.10.0.1&quot;,</span><br><span class="line">      &quot;kubernetes&quot;,</span><br><span class="line">      &quot;kubernetes.default&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc.cluster.local&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; admin-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;admin&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:masters&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="三、部署Etcd集群"><a href="#三、部署Etcd集群" class="headerlink" title="三、部署Etcd集群"></a>三、部署Etcd集群</h3><p>创建 hosts</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">192.168.254.3 etcd01 etcd01.k8s.com</span><br><span class="line">192.168.254.4 etcd02 etcd02.k8s.com</span><br><span class="line">192.168.254.5 etcd03 etcd03.k8s.com</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="创建etcd配置文件"><a href="#创建etcd配置文件" class="headerlink" title="创建etcd配置文件"></a>创建etcd配置文件</h4><p>192.168.254.3</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/etcd.conf &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">[Member]</span></span><br><span class="line">ETCD_NAME=&quot;etcd-1&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.254.3:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.254.3:2379&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">[Clustering]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.254.3:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.254.3:2379&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd-1=https://192.168.254.3:2380,etcd-2=https://192.168.254.4:2380,etcd-3=https://192.168.254.5:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<p>192.168.254.4</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/etcd.conf &lt;&lt; EOF</span><br><span class="line">#[Member]</span><br><span class="line">ETCD_NAME=&quot;etcd-2&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.254.4:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.254.4:2379&quot;</span><br><span class="line">#[Clustering]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.254.4:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.254.4:2379&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd-1=https://192.168.254.3:2380,etcd-2=https://192.168.254.4:2380,etcd-3=https://192.168.254.5:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>192.168.254.5</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/etcd.conf &lt;&lt; EOF</span><br><span class="line">#[Member]</span><br><span class="line">ETCD_NAME=&quot;etcd-3&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.254.5:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.254.5:2379&quot;</span><br><span class="line">#[Clustering]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.254.5:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.254.5:2379&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd-1=https://192.168.254.3:2380,etcd-2=https://192.168.254.4:2380,etcd-3=https://192.168.254.5:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<ul>
<li>ETCD_NAME：节点名称，集群中唯一</li>
<li>ETCD_DATA_DIR：数据目录</li>
<li>ETCD_LISTEN_PEER_URLS：集群通信监听地址</li>
<li>ETCD_LISTEN_CLIENT_URLS：客户端访问监听地址</li>
<li>ETCD_INITIAL_ADVERTISE_PEER_URLS：集群通告地址</li>
<li>ETCD_ADVERTISE_CLIENT_URLS：客户端通告地址</li>
<li>ETCD_INITIAL_CLUSTER：集群节点地址</li>
<li>ETCD_INITIAL_CLUSTER_TOKEN：集群Token</li>
<li>ETCD_INITIAL_CLUSTER_STATE：加入集群的当前状态，new是新集群，existing表示加入已有集群</li>
</ul>
<p>将master文件全部拷贝到node节点…</p>
<p>ssh-keygen -t rsa -P “”</p>
<p> scp <del>&#x2F;.ssh&#x2F;id_rsa.pub <a href="mailto:&#x72;&#x6f;&#111;&#116;&#x40;&#49;&#x39;&#50;&#46;&#49;&#x36;&#x38;&#x2e;&#50;&#x35;&#x34;&#x2e;&#x34;">&#x72;&#x6f;&#111;&#116;&#x40;&#49;&#x39;&#50;&#46;&#49;&#x36;&#x38;&#x2e;&#50;&#x35;&#x34;&#x2e;&#x34;</a>:</del>&#x2F;.ssh&#x2F;</p>
<p> scp &#x2F;opt&#x2F;kubernetes&#x2F; <a href="mailto:&#114;&#111;&#x6f;&#116;&#64;&#49;&#57;&#50;&#46;&#49;&#x36;&#56;&#46;&#x32;&#53;&#52;&#46;&#52;">&#114;&#111;&#x6f;&#116;&#64;&#49;&#57;&#50;&#46;&#49;&#x36;&#56;&#46;&#x32;&#53;&#52;&#46;&#52;</a>:&#x2F;opt&#x2F;kubernetes&#x2F;</p>
<p> scp &#x2F;opt&#x2F;kubernetes&#x2F; <a href="mailto:&#x72;&#111;&#x6f;&#x74;&#64;&#x31;&#57;&#50;&#46;&#49;&#54;&#x38;&#46;&#50;&#53;&#x34;&#46;&#53;">&#x72;&#111;&#x6f;&#x74;&#64;&#x31;&#57;&#50;&#46;&#49;&#54;&#x38;&#46;&#50;&#53;&#x34;&#46;&#53;</a>:&#x2F;opt&#x2F;kubernetes&#x2F;</p>
<h4 id="systemd管理etcd"><a href="#systemd管理etcd" class="headerlink" title="systemd管理etcd"></a>systemd管理etcd</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/etcd.conf</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下面这句必须添加</span></span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/opt/kubernetes/bin/etcd \</span><br><span class="line">--cert-file=/opt/kubernetes/ssl/server.pem \</span><br><span class="line">--key-file=/opt/kubernetes/ssl/server-key.pem \</span><br><span class="line">--peer-cert-file=/opt/kubernetes/ssl/server.pem \</span><br><span class="line">--peer-key-file=/opt/kubernetes/ssl/server-key.pem \</span><br><span class="line">--trusted-ca-file=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">--peer-trusted-ca-file=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">--logger=zap</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="启动并设置开机启动"><a href="#启动并设置开机启动" class="headerlink" title="启动并设置开机启动"></a>启动并设置开机启动</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable etcd &amp;&amp; systemctl daemon-reload &amp;&amp; systemctl start etcd</span><br></pre></td></tr></table></figure>



<h4 id="校验集群是否成功。"><a href="#校验集群是否成功。" class="headerlink" title="校验集群是否成功。"></a>校验集群是否成功。</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/bin/etcdctl --cacert=/opt/kubernetes/ssl/ca.pem --cert=/opt/kubernetes/ssl/server.pem --key=/opt/kubernetes/ssl/server-key.pem --endpoints=&quot;https://192.168.254.3:2379,https://192.168.254.4:2379,https://192.168.254.5:2379&quot; endpoint health</span><br><span class="line"></span><br><span class="line">https://192.168.254.5:2379 is healthy: successfully committed proposal: took = 38.745283ms</span><br><span class="line">https://192.168.254.4:2379 is healthy: successfully committed proposal: took = 38.257777ms</span><br><span class="line">https://192.168.254.3:2379 is healthy: successfully committed proposal: took = 39.501895ms</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="四、安装Docker"><a href="#四、安装Docker" class="headerlink" title="四、安装Docker"></a>四、安装Docker</h3><h4 id="4-1-解压二进制包"><a href="#4-1-解压二进制包" class="headerlink" title="4.1 解压二进制包"></a>4.1 解压二进制包</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf docker-19.03.9.tgz</span><br><span class="line">mv docker/* /usr/bin</span><br></pre></td></tr></table></figure>

<h4 id="4-2-systemd管理docker"><a href="#4-2-systemd管理docker" class="headerlink" title="4.2 systemd管理docker"></a>4.2 systemd管理docker</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/bin/dockerd</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="4-3-创建配置文件"><a href="#4-3-创建配置文件" class="headerlink" title="4.3 创建配置文件"></a>4.3 创建配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/docker</span><br><span class="line">cat /etc/docker/daemon.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;exec-opts&quot;: [&quot;native.cgroupdriver=cgroupfs&quot;],</span><br><span class="line">    &quot;registry-mirrors&quot;: [</span><br><span class="line">        &quot;https://1nj0zren.mirror.aliyuncs.com&quot;,</span><br><span class="line">        &quot;https://kfwkfulq.mirror.aliyuncs.com&quot;,</span><br><span class="line">        &quot;https://2lqq34jg.mirror.aliyuncs.com&quot;,</span><br><span class="line">        &quot;https://pee6w651.mirror.aliyuncs.com&quot;,</span><br><span class="line">        &quot;http://hub-mirror.c.163.com&quot;,</span><br><span class="line">        &quot;https://docker.mirrors.ustc.edu.cn&quot;,</span><br><span class="line">        &quot;http://f1361db2.m.daocloud.io&quot;,</span><br><span class="line">        &quot;https://registry.docker-cn.com&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="4-4-启动并设置开机启动"><a href="#4-4-启动并设置开机启动" class="headerlink" title="4.4 启动并设置开机启动"></a>4.4 启动并设置开机启动</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable docker &amp;&amp; systemctl daemon-reload &amp;&amp; systemctl restart docker</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看是不是cgroup</span></span><br><span class="line"></span><br><span class="line">docker info | grep &quot;Cgroup Driver&quot;</span><br></pre></td></tr></table></figure>



<h3 id="五，设置metric-server"><a href="#五，设置metric-server" class="headerlink" title="五，设置metric-server"></a>五，设置metric-server</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; metrics-server-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:metrics-server&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;system&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem -ca-key=/opt/kubernetes/ssl/ca-key.pem -config=ca-config.json -profile=kubernetes metrics-server-csr.json | cfssljson -bare metrics-server</span><br></pre></td></tr></table></figure>



<p>复制到node节点</p>
<p> scp metrics*  <a href="mailto:&#x72;&#111;&#x6f;&#116;&#x40;&#49;&#57;&#50;&#46;&#49;&#x36;&#56;&#x2e;&#x32;&#x35;&#x34;&#x2e;&#x34;">&#x72;&#111;&#x6f;&#116;&#x40;&#49;&#57;&#50;&#46;&#49;&#x36;&#56;&#x2e;&#x32;&#x35;&#x34;&#x2e;&#x34;</a>:&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;</p>
<p> scp metrics*  <a href="mailto:&#114;&#x6f;&#111;&#x74;&#x40;&#49;&#57;&#50;&#46;&#49;&#54;&#56;&#x2e;&#x32;&#53;&#52;&#x2e;&#53;">&#114;&#x6f;&#111;&#x74;&#x40;&#49;&#57;&#50;&#46;&#49;&#54;&#56;&#x2e;&#x32;&#53;&#52;&#x2e;&#53;</a>:&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;</p>
<h3 id="六，设置-kubectl-参数"><a href="#六，设置-kubectl-参数" class="headerlink" title="六，设置 kubectl 参数"></a>六，设置 kubectl 参数</h3><p>获取token值</p>
<p>head -c 16 &#x2F;dev&#x2F;urandom | od -An -t x | tr -d ‘ ‘</p>
<p>646f992b6f607b2dfbb1c6d4c8ee3ee9</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; token.csv &lt;&lt;EOF</span><br><span class="line">646f992b6f607b2dfbb1c6d4c8ee3ee9,kubelet-bootstrap,10001,&quot;system:kubelet-bootstrap&quot;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 创建kubelet bootstrapping kubeconfig</span><br><span class="line">export KUBE_APISERVER=&quot;https://192.168.254.3:6443&quot;</span><br><span class="line"></span><br><span class="line"># 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes  --certificate-authority=/opt/kubernetes/ssl/ca.pem --embed-certs=true --server=https://192.168.254.3:6443 --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"># 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials kubelet-bootstrap --token=646f992b6f607b2dfbb1c6d4c8ee3ee9 --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"># 设置上下文参数</span><br><span class="line">kubectl config set-context default --cluster=kubernetes --user=kubelet-bootstrap --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"># 设置默认上下文</span><br><span class="line">kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">#----------------------</span><br><span class="line"></span><br><span class="line"># 创建kubelet kubelet.kubeconfig </span><br><span class="line">export KUBE_APISERVER=&quot;https://192.168.254.3:6443&quot;</span><br><span class="line"></span><br><span class="line"># 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes  --certificate-authority=/opt/kubernetes/ssl/ca.pem --embed-certs=true --server=https://192.168.254.3:6443 --kubeconfig=kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line"># 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials kubelet-kubeconfig --token=646f992b6f607b2dfbb1c6d4c8ee3ee9 --kubeconfig=kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line"># 设置上下文参数</span><br><span class="line">kubectl config set-context default --cluster=kubernetes --user=kubelet-kubeconfig --kubeconfig=kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line"># 设置默认上下文</span><br><span class="line">kubectl config use-context default --kubeconfig=kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#----------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; kube-proxy-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem -ca-key=/opt/kubernetes/ssl/ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 创建kube-proxy kubeconfig文件</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=https://192.168.254.3:6443 \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate=/opt/kubernetes/ssl/kube-proxy.pem \</span><br><span class="line">  --client-key=/opt/kubernetes/ssl/kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">./kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cp *kubeconfig /opt/kubernetes/ssl/</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="七，安装master节点"><a href="#七，安装master节点" class="headerlink" title="七，安装master节点"></a>七，安装master节点</h3><p>此master节点也会当做node节点，上面会部署pod，</p>
<p>安装组件如下：</p>
<p>kube-apiserver</p>
<p>kube-controllermanager</p>
<p>kube-scheduler</p>
<p>kube-proxy</p>
<p>kubelete</p>
<h4 id="7-1-部署kube-apiserver"><a href="#7-1-部署kube-apiserver" class="headerlink" title="7.1 部署kube-apiserver"></a>7.1 部署kube-apiserver</h4><h5 id="1-创建配置文件"><a href="#1-创建配置文件" class="headerlink" title="1. 创建配置文件"></a>1. 创建配置文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kube-apiserver.conf &lt;&lt; EOF</span><br><span class="line">KUBE_APISERVER_OPTS=&quot;--logtostderr=true \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--log-dir=/opt/kubernetes/logs \\</span><br><span class="line">--etcd-servers=https://192.168.254.3:2379,https://192.168.254.4:2379,https://192.168.254.5:2379 \\</span><br><span class="line">--bind-address=192.168.254.3 \\</span><br><span class="line">--secure-port=6443 \\</span><br><span class="line">--advertise-address=192.168.254.3 \\</span><br><span class="line">--allow-privileged=true \\</span><br><span class="line">--service-cluster-ip-range=10.0.0.0/24 \\</span><br><span class="line">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\</span><br><span class="line">--authorization-mode=RBAC,Node \\</span><br><span class="line">--enable-bootstrap-token-auth=true \\</span><br><span class="line">--token-auth-file=/opt/kubernetes/cfg/token.csv \\</span><br><span class="line">--service-node-port-range=30000-32767 \\</span><br><span class="line">--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem \\</span><br><span class="line">--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \\</span><br><span class="line">--tls-cert-file=/opt/kubernetes/ssl/server.pem  \\</span><br><span class="line">--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\</span><br><span class="line">--client-ca-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="line">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\</span><br><span class="line">--etcd-cafile=/opt/etcd/ssl/ca.pem \\</span><br><span class="line">--etcd-certfile=/opt/etcd/ssl/server.pem \\</span><br><span class="line">--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\</span><br><span class="line">--audit-log-maxage=30 \\</span><br><span class="line">--audit-log-maxbackup=3 \\</span><br><span class="line">--audit-log-maxsize=100 \\</span><br><span class="line">--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注：上面两个\ \ 第一个是转义符，第二个是换行符，使用转义符是为了使用EOF保留换行符。</p>
</blockquote>
<ul>
<li>–logtostderr：启用日志</li>
<li>—v：日志等级</li>
<li>–log-dir：日志目录</li>
<li>–etcd-servers：etcd集群地址</li>
<li>–bind-address：监听地址</li>
<li>–secure-port：https安全端口</li>
<li>–advertise-address：集群通告地址</li>
<li>–allow-privileged：启用授权</li>
<li>–service-cluster-ip-range：Service虚拟IP地址段</li>
<li>–enable-admission-plugins：准入控制模块</li>
<li>–authorization-mode：认证授权，启用RBAC授权和节点自管理</li>
<li>–enable-bootstrap-token-auth：启用TLS bootstrap机制</li>
<li>–token-auth-file：bootstrap token文件</li>
<li>–service-node-port-range：Service nodeport类型默认分配端口范围</li>
<li>–kubelet-client-xxx：apiserver访问kubelet客户端证书</li>
<li>–tls-xxx-file：apiserver https证书</li>
<li>–etcd-xxxfile：连接Etcd集群证书</li>
<li>–audit-log-xxx：审计日志</li>
</ul>
<h5 id="4-systemd管理apiserver"><a href="#4-systemd管理apiserver" class="headerlink" title="4. systemd管理apiserver"></a>4. systemd管理apiserver</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-apiserver.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-apiserver \$KUBE_APISERVER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h5 id="5-启动并设置开机启动"><a href="#5-启动并设置开机启动" class="headerlink" title="5,启动并设置开机启动"></a>5,启动并设置开机启动</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable kube-apiserver &amp;&amp; systemctl daemon-reload &amp;&amp; systemctl restart kube-apiserver</span><br></pre></td></tr></table></figure>

<h5 id="6-授权kubelet-bootstrap用户允许请求证书"><a href="#6-授权kubelet-bootstrap用户允许请求证书" class="headerlink" title="6. 授权kubelet-bootstrap用户允许请求证书"></a>6. 授权kubelet-bootstrap用户允许请求证书</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubelet-bootstrap \</span><br><span class="line">--clusterrole=system:node-bootstrapper \</span><br><span class="line">--user=kubelet-bootstrap</span><br></pre></td></tr></table></figure>



<p>注意：</p>
<p>如果 kube-apiserver启动失败，使用如下指令</p>
<p>!&#x2F;bin&#x2F;sh</p>
<p> nohup  kube-apiserver –logtostderr&#x3D;false  –v&#x3D;2  –log-dir&#x3D;&#x2F;var&#x2F;log&#x2F;kubernetes  –etcd-servers&#x3D;<a href="https://192.168.254.3:2379,https://192.168.254.4:2379,https://192.168.254.5:2379">https://192.168.254.3:2379,https://192.168.254.4:2379,https://192.168.254.5:2379</a>  –bind-address&#x3D;0.0.0.0  –secure-port&#x3D;6443  –advertise-address&#x3D;192.168.254.3  –allow-privileged&#x3D;true  –service-cluster-ip-range&#x3D;10.10.0.0&#x2F;16  –enable-admission-plugins&#x3D;NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota,NodeRestriction  –authorization-mode&#x3D;RBAC,Node  –kubelet-https&#x3D;true  –enable-bootstrap-token-auth&#x3D;true  –token-auth-file&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;token.csv  –service-node-port-range&#x3D;30000-50000  –kubelet-client-certificate&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;server.pem  –kubelet-client-key&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;server-key.pem  –tls-cert-file&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;server.pem   –tls-private-key-file&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;server-key.pem  –client-ca-file&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;ca.pem  –service-account-key-file&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;ca-key.pem  –etcd-cafile&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;ca.pem  –etcd-certfile&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;server.pem  –etcd-keyfile&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;server-key.pem  –requestheader-client-ca-file&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;ca.pem  –requestheader-extra-headers-prefix&#x3D;X-Remote-Extra-  –requestheader-group-headers&#x3D;X-Remote-Group  –requestheader-username-headers&#x3D;X-Remote-User  –proxy-client-cert-file&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;metrics-server.pem  –proxy-client-key-file&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;metrics-server-key.pem  –runtime-config&#x3D;api&#x2F;all&#x3D;true  –audit-log-maxage&#x3D;30  –audit-log-maxbackup&#x3D;3  –audit-log-maxsize&#x3D;100  –audit-log-truncate-enabled&#x3D;true  –audit-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;kubernetes&#x2F;k8s-audit.log  &amp; </p>
<p>查看 kube-apiserver是否启动起来</p>
<p>ps -ef | grep kube</p>
<p>或者</p>
<p>netstat -ntpl | grep kube-</p>
<h4 id="7-2-部署kube-controller-manager"><a href="#7-2-部署kube-controller-manager" class="headerlink" title="7.2 部署kube-controller-manager"></a>7.2 部署kube-controller-manager</h4><h5 id="1-创建配置文件-1"><a href="#1-创建配置文件-1" class="headerlink" title="1. 创建配置文件"></a>1. 创建配置文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kube-controller-manager.conf &lt;&lt; EOF</span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS=&quot;--logtostderr=false \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--log-dir=/opt/kubernetes/logs \\</span><br><span class="line">--leader-elect=true \\</span><br><span class="line">--master=127.0.0.1:8080 \\</span><br><span class="line">--bind-address=127.0.0.1 \\</span><br><span class="line">--allocate-node-cidrs=true \\</span><br><span class="line">--cluster-cidr=10.244.0.0/16 \\</span><br><span class="line">--service-cluster-ip-range=10.0.0.0/24 \\</span><br><span class="line">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="line">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\</span><br><span class="line">--root-ca-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="line">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\</span><br><span class="line">--experimental-cluster-signing-duration=87600h0m0s&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>-master：通过本地非安全本地端口8080连接apiserver。</p>
<p>–leader-elect：当该组件启动多个时，自动选举（HA）</p>
<p>–cluster-signing-cert-file&#x2F;–cluster-signing-key-file：自动为kubelet颁发证书的CA，与apiserver保持一致</p>
<h5 id="2-systemd管理controller-manager"><a href="#2-systemd管理controller-manager" class="headerlink" title="2. systemd管理controller-manager"></a>2. systemd管理controller-manager</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h5 id="3-启动并设置开机启动"><a href="#3-启动并设置开机启动" class="headerlink" title="3. 启动并设置开机启动"></a>3. 启动并设置开机启动</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload &amp;&amp; systemctl start kube-controller-manager</span><br><span class="line">&amp;&amp; systemctl enable kube-controller-manager</span><br></pre></td></tr></table></figure>

<h4 id="7-3-部署kube-scheduler"><a href="#7-3-部署kube-scheduler" class="headerlink" title="7.3 部署kube-scheduler"></a>7.3 部署kube-scheduler</h4><h5 id="1-创建配置文件-2"><a href="#1-创建配置文件-2" class="headerlink" title="1. 创建配置文件"></a>1. 创建配置文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kube-scheduler.conf &lt;&lt; EOF</span><br><span class="line">KUBE_SCHEDULER_OPTS=&quot;--logtostderr=false \</span><br><span class="line">--v=2 \</span><br><span class="line">--log-dir=/opt/kubernetes/logs \</span><br><span class="line">--leader-elect \</span><br><span class="line">--master=127.0.0.1:8080 \</span><br><span class="line">--bind-address=127.0.0.1&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>–master：通过本地非安全本地端口8080连接apiserver。</li>
<li>–leader-elect：当该组件启动多个时，自动选举（HA）</li>
</ul>
<h5 id="2-systemd管理scheduler"><a href="#2-systemd管理scheduler" class="headerlink" title="2. systemd管理scheduler"></a>2. systemd管理scheduler</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-scheduler \$KUBE_SCHEDULER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h5 id="3-启动并设置开机启动-1"><a href="#3-启动并设置开机启动-1" class="headerlink" title="3. 启动并设置开机启动"></a>3. 启动并设置开机启动</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload &amp;&amp; systemctl start kube-scheduler</span><br><span class="line">systemctl enable kube-scheduler</span><br></pre></td></tr></table></figure>

<h5 id="4-查看集群状态"><a href="#4-查看集群状态" class="headerlink" title="4. 查看集群状态"></a>4. 查看集群状态</h5><p>所有组件都已经启动成功，通过kubectl工具查看当前集群组件状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;  </span><br></pre></td></tr></table></figure>

<p>如上输出说明Master节点组件运行正常。</p>
<p>查看整个组件的情况</p>
<p>netstat -ntpl | grep kube-</p>
<p>如下情况：</p>
<p>tcp        0      0 127.0.0.1:8080          0.0.0.0:*               LISTEN      60387&#x2F;kube-apiserve<br>tcp        0      0 127.0.0.1:10257         0.0.0.0:*               LISTEN      3711&#x2F;kube-controlle<br>tcp        0      0 127.0.0.1:10259         0.0.0.0:*               LISTEN      3821&#x2F;kube-scheduler<br>tcp6       0      0 :::10251                :::*                    LISTEN      3821&#x2F;kube-scheduler<br>tcp6       0      0 :::6443                 :::*                    LISTEN      60387&#x2F;kube-apiserve<br>tcp6       0      0 :::10252                :::*                    LISTEN      3711&#x2F;kube-controlle</p>
<p>执行下面指令，生成config文件。<br>mkdir ~&#x2F;.kube &amp;&amp; 、cp  &#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;admin.kubeconfig    ~&#x2F;.kube&#x2F;config</p>
<h3 id="六，配置kubelet证书自动续期和创建Node授权用户"><a href="#六，配置kubelet证书自动续期和创建Node授权用户" class="headerlink" title="六，配置kubelet证书自动续期和创建Node授权用户"></a>六，配置kubelet证书自动续期和创建Node授权用户</h3><p>此操作还是master节点执行。node节点也要执行</p>
<p>创建 <code>Node节点</code> 授权用户 <code>kubelet-bootstrap</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding  kubelet-bootstrap --clusterrole=system:node-bootstrapper  --user=kubelet-bootstrap</span><br></pre></td></tr></table></figure>

<p>创建自动批准相关 CSR 请求的 ClusterRole</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim tls-instructs-csr.yaml </span><br><span class="line"></span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeserver</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [<span class="string">&quot;certificates.k8s.io&quot;</span>]</span><br><span class="line">  resources: [<span class="string">&quot;certificatesigningrequests/selfnodeserver&quot;</span>]</span><br><span class="line">  verbs: [<span class="string">&quot;create&quot;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl apply -f tls-instructs-csr.yaml</span><br></pre></td></tr></table></figure>



<p>自动批准 kubelet-bootstrap 用户 TLS bootstrapping 首次申请证书的 CSR 请求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding node-client-auto-approve-csr --clusterrole=system:certificates.k8s.io:certificatesigningrequests:nodeclient --user=kubelet-bootstrap</span><br></pre></td></tr></table></figure>

<p> 自动批准 system:nodes 组用户更新 kubelet 自身与 apiserver 通讯证书的 CSR 请求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding node-client-auto-renew-crt --clusterrole=system:certificates.k8s.io:certificatesigningrequests:selfnodeclient --group=system:nodes</span><br></pre></td></tr></table></figure>

<p> 自动批准 system:nodes 组用户更新 kubelet 10250 api 端口证书的 CSR 请求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding node-server-auto-renew-crt --clusterrole=system:certificates.k8s.io:certificatesigningrequests:selfnodeserver --group=system:nodes</span><br></pre></td></tr></table></figure>

<h3 id="七，配置Node组件并运行"><a href="#七，配置Node组件并运行" class="headerlink" title="七，配置Node组件并运行"></a>七，配置Node组件并运行</h3><p>此步骤依然在master节点配置，因为master节点也是作为一个node节点。</p>
<p><a target="_blank" rel="noopener" href="https://blog.51cto.com/yht1990/2539729">https://blog.51cto.com/yht1990/2539729</a></p>
<h4 id="7-1-配置-kubelet"><a href="#7-1-配置-kubelet" class="headerlink" title="7.1 配置 kubelet"></a>7.1 配置 kubelet</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt;/opt/kubernetes/cfg/kubelet.conf</span></span><br><span class="line"><span class="string">KUBELET_OPTS=&quot;--logtostderr=true \\</span></span><br><span class="line"><span class="string">--v=2 \\</span></span><br><span class="line"><span class="string">--hostname-override=k8s-master \\</span></span><br><span class="line"><span class="string">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\</span></span><br><span class="line"><span class="string">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\</span></span><br><span class="line"><span class="string">--config=/opt/kubernetes/cfg/kubelet-config.yml \\</span></span><br><span class="line"><span class="string">--cert-dir=/opt/kubernetes/ssl \\</span></span><br><span class="line"><span class="string">--network-plugin=cni \\</span></span><br><span class="line"><span class="string">--cni-conf-dir=/etc/cni/net.d \\</span></span><br><span class="line"><span class="string">--cni-bin-dir=/opt/cni/bin \\</span></span><br><span class="line"><span class="string">--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt;/opt/kubernetes/cfg/kubelet-config.yml</span></span><br><span class="line"><span class="string">kind: KubeletConfiguration # 使用对象</span></span><br><span class="line"><span class="string">apiVersion: kubelet.config.k8s.io/v1beta1 # api版本</span></span><br><span class="line"><span class="string">address: 0.0.0.0 # 监听地址</span></span><br><span class="line"><span class="string">port: 10250 # 当前kubelet的端口</span></span><br><span class="line"><span class="string">readOnlyPort: 10255 # kubelet暴露的端口</span></span><br><span class="line"><span class="string">cgroupDriver: cgroupfs # 驱动，要于docker info显示的驱动一致</span></span><br><span class="line"><span class="string">clusterDNS:</span></span><br><span class="line"><span class="string">  - 10.10.0.2</span></span><br><span class="line"><span class="string">clusterDomain: cluster.local  # 集群域</span></span><br><span class="line"><span class="string">failSwapOn: false # 关闭swap</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 身份验证</span></span><br><span class="line"><span class="string">authentication:</span></span><br><span class="line"><span class="string">  anonymous:</span></span><br><span class="line"><span class="string">    enabled: false</span></span><br><span class="line"><span class="string">  webhook:</span></span><br><span class="line"><span class="string">    cacheTTL: 2m0s</span></span><br><span class="line"><span class="string">    enabled: true</span></span><br><span class="line"><span class="string">  x509:</span></span><br><span class="line"><span class="string">    clientCAFile: /opt/kubernetes/ssl/ca.pem</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 授权</span></span><br><span class="line"><span class="string">authorization:</span></span><br><span class="line"><span class="string">  mode: Webhook</span></span><br><span class="line"><span class="string">  webhook:</span></span><br><span class="line"><span class="string">    cacheAuthorizedTTL: 5m0s</span></span><br><span class="line"><span class="string">    cacheUnauthorizedTTL: 30s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Node 资源保留</span></span><br><span class="line"><span class="string">evictionHard:</span></span><br><span class="line"><span class="string">  imagefs.available: 15%</span></span><br><span class="line"><span class="string">  memory.available: 1G</span></span><br><span class="line"><span class="string">  nodefs.available: 10%</span></span><br><span class="line"><span class="string">  nodefs.inodesFree: 5%</span></span><br><span class="line"><span class="string">evictionPressureTransitionPeriod: 5m0s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 镜像删除策略</span></span><br><span class="line"><span class="string">imageGCHighThresholdPercent: 85</span></span><br><span class="line"><span class="string">imageGCLowThresholdPercent: 80</span></span><br><span class="line"><span class="string">imageMinimumGCAge: 2m0s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 旋转证书</span></span><br><span class="line"><span class="string">rotateCertificates: true # 旋转kubelet client 证书</span></span><br><span class="line"><span class="string">featureGates:</span></span><br><span class="line"><span class="string">  RotateKubeletServerCertificate: true</span></span><br><span class="line"><span class="string">  RotateKubeletClientCertificate: true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">maxOpenFiles: 1000000</span></span><br><span class="line"><span class="string">maxPods: 110</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt;/usr/lib/systemd/system/kubelet.service</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Kubernetes Kubelet</span></span><br><span class="line"><span class="string">After=docker.service</span></span><br><span class="line"><span class="string">Requires=docker.service</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">EnvironmentFile=-/opt/kubernetes/cfg/kubelet.conf</span></span><br><span class="line"><span class="string">ExecStart=/opt/kubernetes/bin/kubelet \$KUBELET_OPTS</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string">KillMode=process</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> kubelet &amp;&amp; systemctl restart kubelet</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="7-2-配置-kube-proxy"><a href="#7-2-配置-kube-proxy" class="headerlink" title="7.2 配置 kube-proxy"></a>7.2 配置 kube-proxy</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">HOSTNAME=<span class="variable">$&#123;1:-&quot;`hostname`&quot;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt;/opt/kubernetes/cfg/kube-proxy.conf</span></span><br><span class="line"><span class="string">KUBE_PROXY_OPTS=&quot;--logtostderr=true \\</span></span><br><span class="line"><span class="string">--v=2 \\</span></span><br><span class="line"><span class="string">--config=/opt/kubernetes/cfg/kube-proxy-config.yml&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt;/opt/kubernetes/cfg/kube-proxy-config.yml</span></span><br><span class="line"><span class="string">kind: KubeProxyConfiguration</span></span><br><span class="line"><span class="string">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="string">address: 0.0.0.0 # 监听地址</span></span><br><span class="line"><span class="string">metricsBindAddress: 0.0.0.0:10249 # 监控指标地址,监控获取相关信息 就从这里获取</span></span><br><span class="line"><span class="string">clientConnection:</span></span><br><span class="line"><span class="string">  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig # 读取配置文件</span></span><br><span class="line"><span class="string">hostnameOverride: k8s-master # 注册到k8s的节点名称唯一</span></span><br><span class="line"><span class="string">clusterCIDR: 10.10.0.0/16 # service IP范围</span></span><br><span class="line"><span class="string">mode: iptables # 使用iptables模式</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 使用 ipvs 模式</span></span><br><span class="line"><span class="string">#mode: ipvs # ipvs 模式</span></span><br><span class="line"><span class="string">#ipvs:</span></span><br><span class="line"><span class="string">#  scheduler: &quot;rr&quot;</span></span><br><span class="line"><span class="string">#iptables:</span></span><br><span class="line"><span class="string">#  masqueradeAll: true</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt;/usr/lib/systemd/system/kube-proxy.service</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Kubernetes Proxy</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">EnvironmentFile=-/opt/kubernetes/cfg/kube-proxy.conf</span></span><br><span class="line"><span class="string">ExecStart=/opt/kubernetes/bin/kube-proxy \$KUBE_PROXY_OPTS</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> kube-proxy &amp;&amp; systemctl restart kube-proxy</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成 node 配置文件</span></span><br><span class="line">$ ./kubelet.sh 10.10.0.2 k8s-master1 cluster.local</span><br><span class="line">$ ./proxy.sh k8s-master1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务是否启动</span></span><br><span class="line">$ netstat -ntpl | egrep <span class="string">&quot;kubelet|kube-proxy&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>查看节点是否成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 随便登陆一台master机器查看node节点是否添加成功</span></span><br><span class="line">$ kubectl get node</span><br><span class="line"></span><br><span class="line">[root@k8s-master ssl]<span class="comment"># kubectl get node</span></span><br><span class="line">NAME         STATUS     ROLES    AGE     VERSION</span><br><span class="line">k8s-master   NotReady   &lt;none&gt;   9m22s   v1.18.9</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="7-3-部署CNI网络"><a href="#7-3-部署CNI网络" class="headerlink" title="7.3 部署CNI网络"></a>7.3 部署CNI网络</h4><p>先准备好CNI二进制文件：</p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/containernetworking/plugins/releases/download/v0.8.6/cni-plugins-linux-amd64-v0.8.6.tgz">https://github.com/containernetworking/plugins/releases/download/v0.8.6/cni-plugins-linux-amd64-v0.8.6.tgz</a></p>
<p>解压二进制包并移动到默认工作目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /opt/cni/bin</span><br><span class="line">tar zxvf cni-plugins-linux-amd64-v0.8.6.tgz -C /opt/cni/bin</span><br></pre></td></tr></table></figure>

<p>部署CNI网络：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line">sed -i -r &quot;s#quay.io/coreos/flannel:.*-amd64#lizhenliang/flannel:v0.12.0-amd64#g&quot; kube-flannel.yml</span><br></pre></td></tr></table></figure>

<p>默认镜像地址无法访问，修改为docker hub镜像仓库。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kube-flannel.yml</span><br><span class="line"></span><br><span class="line">kubectl get pods -n kube-system</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-flannel-ds-amd64-2pc95   1/1     Running   0          72s</span><br><span class="line"></span><br><span class="line">kubectl get node</span><br><span class="line">NAME         STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s-master   Ready    &lt;none&gt;   41m   v1.18.9</span><br></pre></td></tr></table></figure>

<p>部署好网络插件，Node准备就绪。</p>
<h4 id="7-4-授权apiserver访问kubelet"><a href="#7-4-授权apiserver访问kubelet" class="headerlink" title="7.4 授权apiserver访问kubelet"></a>7.4 授权apiserver访问kubelet</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; apiserver-to-kubelet-rbac.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:kube-apiserver-to-kubelet</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - nodes/proxy</span><br><span class="line">      - nodes/stats</span><br><span class="line">      - nodes/log</span><br><span class="line">      - nodes/spec</span><br><span class="line">      - nodes/metrics</span><br><span class="line">      - pods/log</span><br><span class="line">    verbs:</span><br><span class="line">      - &quot;*&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: system:kube-apiserver</span><br><span class="line">  namespace: &quot;&quot;</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:kube-apiserver-to-kubelet</span><br><span class="line">subjects:</span><br><span class="line">  - apiGroup: rbac.authorization.k8s.io</span><br><span class="line">    kind: User</span><br><span class="line">    name: kubernetes</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f apiserver-to-kubelet-rbac.yaml</span><br></pre></td></tr></table></figure>

<h3 id="八，新增加Worker-Node"><a href="#八，新增加Worker-Node" class="headerlink" title="八，新增加Worker Node"></a>八，新增加Worker Node</h3><h4 id="1-拷贝已部署好的Node相关文件到新节点"><a href="#1-拷贝已部署好的Node相关文件到新节点" class="headerlink" title="1. 拷贝已部署好的Node相关文件到新节点"></a>1. 拷贝已部署好的Node相关文件到新节点</h4><p>在master节点将Worker Node涉及文件拷贝到新节点192.168.31.72&#x2F;73</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scp /opt/kubernetes root@192.168.31.72:/opt/</span><br><span class="line">scp -r /usr/lib/systemd/system/&#123;kubelet,kube-proxy&#125;.service root@192.168.31.72:/usr/lib/systemd/system</span><br><span class="line">scp -r /opt/cni/ root@192.168.31.72:/opt/</span><br><span class="line">scp /opt/kubernetes/ssl/ca.pem root@192.168.31.72:/opt/kubernetes/ssl</span><br></pre></td></tr></table></figure>

<h4 id="2-删除kubelet证书和kubeconfig文件"><a href="#2-删除kubelet证书和kubeconfig文件" class="headerlink" title="2. 删除kubelet证书和kubeconfig文件"></a>2. 删除kubelet证书和kubeconfig文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm /opt/kubernetes/cfg/kubelet.kubeconfig </span><br><span class="line">rm -f /opt/kubernetes/ssl/kubelet*</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注：这几个文件是证书申请审批后自动生成的，每个Node不同，必须删除重新生成。</p>
</blockquote>
<h4 id="3-修改主机名"><a href="#3-修改主机名" class="headerlink" title="3. 修改主机名"></a>3. 修改主机名</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi /opt/kubernetes/cfg/kubelet.conf</span><br><span class="line">--hostname-override=k8s-node1</span><br><span class="line"></span><br><span class="line">vi /opt/kubernetes/cfg/kube-proxy-config.yml</span><br><span class="line">hostnameOverride: k8s-node1</span><br></pre></td></tr></table></figure>

<h4 id="4-启动并设置开机启动"><a href="#4-启动并设置开机启动" class="headerlink" title="4. 启动并设置开机启动"></a>4. 启动并设置开机启动</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable kube-proxy &amp;&amp; systemctl restart kube-proxy</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable kubelet &amp;&amp; systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="5-在Master上批准新Node-kubelet证书申请"><a href="#5-在Master上批准新Node-kubelet证书申请" class="headerlink" title="5. 在Master上批准新Node kubelet证书申请"></a>5. 在Master上批准新Node kubelet证书申请</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get csr</span><br><span class="line">NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class="line">node-csr-4zTjsaVSrhuyhIGqsefxzVoZDCNKei-aE2jyTP81Uro   89s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class="line"></span><br><span class="line">kubectl certificate approve node-csr-4zTjsaVSrhuyhIGqsefxzVoZDCNKei-aE2jyTP81Uro</span><br></pre></td></tr></table></figure>

<h4 id="6-查看Node状态"><a href="#6-查看Node状态" class="headerlink" title="6. 查看Node状态"></a>6. 查看Node状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line">NAME         STATUS     ROLES    AGE   VERSION</span><br><span class="line">k8s-master   Ready      &lt;none&gt;   65m   v1.18.3</span><br><span class="line">k8s-node1    Ready      &lt;none&gt;   12m   v1.18.3</span><br><span class="line">k8s-node2    Ready      &lt;none&gt;   81s   v1.18.3</span><br></pre></td></tr></table></figure>

<p>Node2（192.168.31.73 ）节点同上。记得修改主机名！</p>
<h2 id="六、部署Dashboard和CoreDNS"><a href="#六、部署Dashboard和CoreDNS" class="headerlink" title="六、部署Dashboard和CoreDNS"></a>六、部署Dashboard和CoreDNS</h2><h3 id="6-1-部署Dashboard"><a href="#6-1-部署Dashboard" class="headerlink" title="6.1 部署Dashboard"></a>6.1 部署Dashboard</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta8/aio/deploy/recommended.yaml</span></span><br></pre></td></tr></table></figure>

<p>默认Dashboard只能集群内部访问，修改Service为NodePort类型，暴露到外部：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">vi recommended.yaml</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 443</span><br><span class="line">      targetPort: 8443</span><br><span class="line">      nodePort: 30001</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">kubectl apply -f recommended.yaml</span><br><span class="line">kubectl get pods,svc -n kubernetes-dashboard</span><br><span class="line">NAME                                             READY   STATUS              RESTARTS   AGE</span><br><span class="line">pod/dashboard-metrics-scraper-694557449d-z8gfb   1/1     Running             0          2m18s</span><br><span class="line">pod/kubernetes-dashboard-9774cc786-q2gsx         1/1     Running             0          2m19s</span><br><span class="line"></span><br><span class="line">NAME                                TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">service/dashboard-metrics-scraper   ClusterIP   10.0.0.141   &lt;none&gt;        8000/TCP        2m19s</span><br><span class="line">service/kubernetes-dashboard        NodePort    10.0.0.239   &lt;none&gt;        443:30001/TCP   2m19s</span><br></pre></td></tr></table></figure>

<p>访问地址：<a target="_blank" rel="noopener" href="https://nodeip:30001/">https://NodeIP:30001</a></p>
<p>创建service account并绑定默认cluster-admin管理员集群角色：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create serviceaccount dashboard-admin -n kube-system</span><br><span class="line">kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin</span><br><span class="line">kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk &#x27;/dashboard-admin/&#123;print $1&#125;&#x27;)</span><br></pre></td></tr></table></figure>

<p>使用输出的token登录Dashboard</p>
<h3 id="6-2-部署CoreDNS"><a href="#6-2-部署CoreDNS" class="headerlink" title="6.2 部署CoreDNS"></a>6.2 部署CoreDNS</h3><p>CoreDNS用于集群内部Service名称解析。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f coredns.yaml</span><br><span class="line"></span><br><span class="line">kubectl get pods -n kube-system </span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-5ffbfd976d-j6shb      1/1     Running   0          32s</span><br><span class="line">kube-flannel-ds-amd64-2pc95   1/1     Running   0          38m</span><br><span class="line">kube-flannel-ds-amd64-7qhdx   1/1     Running   0          15m</span><br><span class="line">kube-flannel-ds-amd64-99cr8   1/1     Running   0          26m</span><br></pre></td></tr></table></figure>

<p>DNS解析测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl run -it --rm dns-test --image=busybox:1.28.4 sh</span><br><span class="line">If you don&#x27;t see a command prompt, try pressing enter.</span><br><span class="line"></span><br><span class="line">/ # nslookup kubernetes</span><br><span class="line">Server:    10.0.0.2</span><br><span class="line">Address 1: 10.0.0.2 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes</span><br><span class="line">Address 1: 10.0.0.1 kubernetes.default.svc.cluster.local</span><br></pre></td></tr></table></figure>

<p>解析没问题。</p>
<p>至此，单Master集群部署完成，下一篇扩容为多Master集群~</p>
<p>常见问题</p>
<h1 id="x509-certificate-signed-by-unknown-authority"><a href="#x509-certificate-signed-by-unknown-authority" class="headerlink" title="x509: certificate signed by unknown authority"></a>x509: certificate signed by unknown authority</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/nklinsirui/article/details/94402310">https://blog.csdn.net/nklinsirui/article/details/94402310</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.51cto.com/lizhenliang/2500242">https://blog.51cto.com/lizhenliang/2500242</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/technology178/p/13547342.html">https://www.cnblogs.com/technology178/p/13547342.html</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/121100475">https://zhuanlan.zhihu.com/p/121100475</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/05/27/build-high-available-k8s/" data-id="cluj9jc9s00083j1mc6757ch6" data-title="搭建高可用k8s集群" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/05/27/code-format/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          架构设计-代码规范
        
      </div>
    </a>
  
  
    <a href="/2023/05/27/architecture-department-thinking/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">architecture-department-thinking</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/IELTS/">IELTS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/articture/">articture</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">June 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/04/03/shell-study/">(no title)</a>
          </li>
        
          <li>
            <a href="/2024/04/03/shell-learn/">shell脚本</a>
          </li>
        
          <li>
            <a href="/2023/06/26/how-to-implement-zero-trust/">how to implement zero trust</a>
          </li>
        
          <li>
            <a href="/2023/06/13/news/">news</a>
          </li>
        
          <li>
            <a href="/2023/06/04/develop-mode/">设计模式</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>